<!--
Code for integrating CloudFlare's email protection with Hydejack's single page app loading.
-->
<script>
  document.getElementById('_pushState').addEventListener('hy-push-state-after', function (e) {
    function e(e){
      (console.error?console.error:console.log).call(console,e)
    }

    function t(e){
      return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href")
    }

    function r(e,t){
      var r=e.substr(t,2);return parseInt(r,16)
    }

    function n(e,n){
      for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){
        var l=r(e,a)^c;
        o+=String.fromCharCode(l)
      }
      return t(o)
    }

    var o="/cdn-cgi/l/email-protection#",
        c=".__cf_email__",
        a="data-cfemail",
        l=document.createElement("div");

    !function(){
      for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)
        try{
          var c=t[r],a=c.href.indexOf(o);
          a>-1&&(c.href="mailto:"+n(c.href,a+o.length))
        }catch(t){
          e(t)
        }
    }(),
    function(){
      for(var t=document.querySelectorAll(c),r=0;r<t.length;r++)
        try{
          var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l);
          o.parentNode.replaceChild(i,o)
        }catch(t){
          e(t)
        }
    }()
  });
</script>

{% comment %}
<!--
Example code for using Matamo as alternative analytics solution.
-->
{% if site.matomo_analytics %}
<script>
  var _paq = _paq || [];

  /*{% if site.matomo_analytics.no_cookies %}*/
  _paq.push(['disableCookies']);
  /*{% endif %}*/

  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  _paq.push(['setTrackerUrl', u+'piwik.php']);
  _paq.push(['setSiteId', '{{site.matomo_analytics.site_id}}']);

  var pushStateEl = document.getElementById('_pushState');
  var timeStartLoadPage, referer, timeItTookToLoadPage;

  pushStateEl.addEventListener('hy-push-state-start', function() {
    timeStartLoadPage = new Date().getTime();
    referer = window.location.toString();
  });

  pushStateEl.addEventListener('hy-push-state-ready', function() {
    timeItTookToLoadPage = new Date().getTime() - timeStartLoadPage;
  });

  pushStateEl.addEventListener('hy-push-state-after', function() {
    _paq.push(['setReferrerUrl', referer]);
    _paq.push(['setCustomUrl', window.location.toString()]);
    _paq.push(['setDocumentTitle', document.title]);
    _paq.push(['deleteCustomVariables', 'page']);
    _paq.push(['setGenerationTimeMs', timeItTookToLoadPage]);
    _paq.push(['trackPageView']);
  });

  window.loadJSDeferred('{{site.matomo_analytics.root}}piwik.js');
</script>
{% endif %}
{% endcomment %}

<!-- Papers 게시글 개수 표시 (즉시 실행) -->
<script>
  console.log('=== Papers Count Script Loaded ===');
  
  function addPapersCount() {
    console.log('--- addPapersCount function start ---');
    
    const papersCount = {{ site.categories.papers | size }};
    console.log('Papers count:', papersCount);
    
    if (papersCount === 0) {
      console.log('Papers count is 0, exiting');
      return;
    }
    
    // 모든 링크 찾기
    const allLinks = document.querySelectorAll('a');
    console.log('Total links on page:', allLinks.length);
    
    // Papers를 포함하는 모든 링크 찾기
    let papersLinks = [];
    allLinks.forEach(function(link) {
      if (link.href && link.href.includes('/papers/')) {
        papersLinks.push(link);
        console.log('Found papers link:', {
          href: link.href,
          text: link.textContent.trim(),
          classes: link.className
        });
      }
    });
    
    console.log('Total papers links found:', papersLinks.length);
    
    // Papers 메뉴 찾기 (텍스트가 정확히 "Papers"인 것)
    let menuFound = false;
    for (let i = 0; i < papersLinks.length; i++) {
      let link = papersLinks[i];
      if (link.textContent.trim() === 'Papers') {
        console.log('Found Papers menu link!');
        
        // 이미 뱃지가 있으면 제거
        const existingBadge = link.querySelector('.papers-count');
        if (existingBadge) {
          console.log('Removing existing badge');
          existingBadge.remove();
        }
        
        // 새 뱃지 추가
        const badge = document.createElement('span');
        badge.className = 'papers-count';
        badge.textContent = ' (' + papersCount + ')';
        badge.style.cssText = 'color:#4f9eba; font-weight:bold;';
        link.appendChild(badge);
        
        console.log('✅ Badge added successfully!');
        menuFound = true;
        break;
      }
    }
    
    if (!menuFound) {
      console.log('❌ Papers menu not found. Link texts:');
      for (let i = 0; i < papersLinks.length; i++) {
        console.log('  - "' + papersLinks[i].textContent.trim() + '"');
      }
    }
    
    console.log('--- addPapersCount function end ---');
  }
  
  // 즉시 실행 시도 1
  addPapersCount();
  console.log('Immediate execution done');
  
  // 지연 실행 시도 2
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded fired');
      addPapersCount();
    });
  } else {
    console.log('DOM already loaded, running addPapersCount');
    addPapersCount();
  }
  
  // 추가 지연 실행
  setTimeout(function() {
    console.log('setTimeout 500ms');
    addPapersCount();
  }, 500);
  
  setTimeout(function() {
    console.log('setTimeout 1500ms');
    addPapersCount();
  }, 1500);
  
  // Hydejack 페이지 전환 이벤트
  var pushEl = document.getElementById('_pushState');
  if (pushEl) {
    console.log('_pushState element found, adding listener');
    pushEl.addEventListener('hy-push-state-after', function() {
      console.log('hy-push-state-after fired');
      addPapersCount();
    });
  } else {
    console.log('_pushState element NOT found');
  }
</script>