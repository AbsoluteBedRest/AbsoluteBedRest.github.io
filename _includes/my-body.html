<!--
Code for integrating CloudFlare's email protection with Hydejack's single page app loading.
-->
<script>
  document.getElementById('_pushState').addEventListener('hy-push-state-after', function (e) {
    function e(e){
      (console.error?console.error:console.log).call(console,e)
    }

    function t(e){
      return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href")
    }

    function r(e,t){
      var r=e.substr(t,2);return parseInt(r,16)
    }

    function n(e,n){
      for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){
        var l=r(e,a)^c;
        o+=String.fromCharCode(l)
      }
      return t(o)
    }

    var o="/cdn-cgi/l/email-protection#",
        c=".__cf_email__",
        a="data-cfemail",
        l=document.createElement("div");

    !function(){
      for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)
        try{
          var c=t[r],a=c.href.indexOf(o);
          a>-1&&(c.href="mailto:"+n(c.href,a+o.length))
        }catch(t){
          e(t)
        }
    }(),
    function(){
      for(var t=document.querySelectorAll(c),r=0;r<t.length;r++)
        try{
          var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l);
          o.parentNode.replaceChild(i,o)
        }catch(t){
          e(t)
        }
    }()
  });
</script>

{% comment %}
<!--
Example code for using Matamo as alternative analytics solution.
-->
{% if site.matomo_analytics %}
<script>
  var _paq = _paq || [];

  /*{% if site.matomo_analytics.no_cookies %}*/
  _paq.push(['disableCookies']);
  /*{% endif %}*/

  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  _paq.push(['setTrackerUrl', u+'piwik.php']);
  _paq.push(['setSiteId', '{{site.matomo_analytics.site_id}}']);

  var pushStateEl = document.getElementById('_pushState');
  var timeStartLoadPage, referer, timeItTookToLoadPage;

  pushStateEl.addEventListener('hy-push-state-start', function() {
    timeStartLoadPage = new Date().getTime();
    referer = window.location.toString();
  });

  pushStateEl.addEventListener('hy-push-state-ready', function() {
    timeItTookToLoadPage = new Date().getTime() - timeStartLoadPage;
  });

  pushStateEl.addEventListener('hy-push-state-after', function() {
    _paq.push(['setReferrerUrl', referer]);
    _paq.push(['setCustomUrl', window.location.toString()]);
    _paq.push(['setDocumentTitle', document.title]);
    _paq.push(['deleteCustomVariables', 'page']);
    _paq.push(['setGenerationTimeMs', timeItTookToLoadPage]);
    _paq.push(['trackPageView']);
  });

  window.loadJSDeferred('{{site.matomo_analytics.root}}piwik.js');
</script>
{% endif %}
{% endcomment %}

<!-- Papers 게시글 개수 표시 -->
<script>
  console.log('=== Papers Count Script Loaded (v2) ===');
  
  function addPapersCount() {
    // 1. Liquid로 빌드 타임에 개수 가져오기 (없으면 0 처리)
    var papersCount = {{ site.categories.papers | size | default: 0 }};
    console.log('Papers count:', papersCount);
    
    // 게시글이 0개여도 메뉴에 (0)이라고 표시하고 싶다면 아래 return을 삭제하세요.
    if (papersCount === 0) {
      console.log('No papers, exiting');
      return;
    }
    
    // 2. 이미 배지가 붙어있는지 확인 (중복 실행 방지)
    if (document.querySelector('.papers-count-badge')) {
      console.log('Badge already exists.');
      return;
    }

    // 3. 모든 a 태그 탐색
    var allLinks = document.querySelectorAll('a');
    
    for (var i = 0; i < allLinks.length; i++) {
      var link = allLinks[i];
      
      // 조건 수정: href에 '/papers/'가 포함되고, 텍스트에 'Papers'가 포함되어 있는지 확인 (일치x 포함o)
      // .sidebar-nav 등 특정 클래스 내부에 있는지도 확인하면 더 좋지만, 범용성을 위해 href로 판단
      if (link.href && link.href.indexOf('/papers/') > -1) {
        
        // 텍스트 확인 (대소문자 무시 및 공백 제거 후 확인)
        var linkText = link.textContent || link.innerText;
        if (linkText.toUpperCase().includes('PAPERS')) {
            console.log('Found Papers menu:', link);
            
            // 기존 배지 제거 (혹시 몰라서)
            var existingBadge = link.querySelector('.papers-count-badge');
            if (existingBadge) existingBadge.remove();
            
            // 새 배지 생성
            var badge = document.createElement('span');
            badge.className = 'papers-count-badge'; // 클래스명 구체화
            badge.textContent = ' ' + papersCount; // 괄호 없이 숫자만 깔끔하게, 혹은 ' (' + papersCount + ')'
            
            // 스타일 적용 (Hydejack 테마 색상과 어울리게)
            badge.style.cssText = 'color: inherit; opacity: 0.6; font-size: 0.9em; margin-left: 5px; font-weight: normal;';
            
            link.appendChild(badge);
            console.log('Badge added successfully!');
            return; // 찾았으면 루프 종료
        }
      }
    }
  }

  // --- 실행 로직 ---
  
  // 1. 페이지 로드 시 즉시 실행
  addPapersCount();
  
  // 2. DOMContentLoaded 이벤트 (HTML 파싱 완료 시)
  document.addEventListener('DOMContentLoaded', addPapersCount);

  // 3. window load 이벤트 (모든 리소스 로드 완료 시)
  window.addEventListener('load', addPapersCount);
  
  // 4. Hydejack SPA 페이지 전환 이벤트 (가장 중요)
  var pushStateEl = document.getElementById('_pushState');
  if (pushStateEl) {
    pushStateEl.addEventListener('hy-push-state-after', function() {
      // 페이지 전환 직후에는 DOM이 다 그려지지 않았을 수 있으므로 약간의 지연을 줌
      setTimeout(addPapersCount, 100); 
    });
  }
</script>